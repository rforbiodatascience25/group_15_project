---
title: "06_analysis_2"
format:
  html:
    embed-resources: true
editor: visual
execute: 
  echo: true
  message: false
  warning: false
---

## Giosu√®

## Correlation plot

The corr plot shows the correlation between all the numeric variables in the dataset, from there we can inspect if there is correlation between variables and how strong.

```{r}
library("tidyverse")
library("PerformanceAnalytics")

kidney_augmented <- read_rds("../data/03_data_augment.rds")

kidney_augmented |>
  select(age, blood_pressure, blood_glucose_random, blood_urea, serum_creatinine, sodium, potassium, hemoglobin, packed_cell_volume, white_blood_cell_count, red_blood_cell_count, GFR_male, GFR_female, GFR_average) |>
  chart.Correlation(histogram = TRUE, pch = 19)
```

## Random forest analysis

Using random forest we are inspecting the variable importance, to further select our variables. This also includes factor variables.

```{r}
library("randomForest")
library("caret")

set.seed(123)

kidney_augmented <- read_rds("../data/03_data_augment.rds")

data <- kidney_augmented |> 
  na.omit() |>
  select(-c(GFR_female, GFR_male, GFR_average, cdk_stage, specific_gravity))

idx <- data$classification |>
  createDataPartition(p = 0.6, list = F)

train <- data[idx,]
test <- data[-idx,]

rf1 <- train |> 
  randomForest(classification ~ ., data = _, importance = T, ntree = 600)

plot(rf1$err.rate[,1], type='l')
```

### Visualizing the confusion matrix

This is used to see the model performance on the test set.

```{r}
pred <- predict(rf1,test)
confusionMatrix(pred,test$classification)
```

### Variables importance plot

This plot is used to see how much each variable is influencing the accuracy of the model.

```{r}
varImpPlot(rf1)
```

### Repeating random forest analysis with important variables

```{r}
kidney_augmented <- read_rds("../data/03_data_augment.rds")

data <- kidney_augmented |> 
  na.omit() |>
  select(-c(GFR_female, GFR_male, GFR_average, cdk_stage, specific_gravity))

idx <- data$classification |>
  createDataPartition(p = 0.6, list = F)

train <- data[idx,]
test <- data[-idx,]

rf2 <- train |> 
  randomForest(classification ~ packed_cell_volume + hemoglobin +
                 serum_creatinine + red_blood_cell_count + albumin + hypertension + diabetes_mellitus,
               data = _, 
               importance = T, 
               ntree = 600)

plot(rf2$err.rate[,1], type='l')
```

```{r}
pred <- predict(rf2,test)
confusionMatrix(pred,test$classification)
```

```{r}
varImpPlot(rf2)
```

## Joel

## New code

```{r}
kidney_analysis <- read_rds("../data/04_data_analysis.rds")
# 1) Pivot to long format for the key continuous predictors
kidney_analysis2 <- kidney_analysis |>
  select(classification,
         albumin,
         serum_creatinine,
         hemoglobin,
         packed_cell_volume,
         red_blood_cell_count) |>
  pivot_longer(
    cols = -classification,
    names_to = "variable",
    values_to = "value"
  ) |>
  drop_na(value)   

# 2) Get per-variable y-limits so we can place n above all boxplots
ylims <- kidney_analysis2 |>
  group_by(variable) |>
  summarise(
    top = max(value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(y_pos = top + (top * 0.15))   

# 3) Compute n per variable *and* classification, then join y_pos
n_labels <- kidney_analysis2 |>
  group_by(variable, classification) |>
  summarise(
    n = n(),               
    .groups = "drop"
  ) |>
  left_join(ylims, by = "variable")

# 4) Faceted boxplot with n labels for CKD and non-CKD in each facet
ggplot(kidney_analysis2,
       aes(x = classification, y = value, fill = classification)) +
  geom_boxplot() +
  geom_text(
    data = n_labels,
    aes(x = classification, y = y_pos, label = paste0("n = ", n)),
    size = 3
  ) +
  facet_wrap(
    ~ variable,
    scales = "free_y",
    labeller = as_labeller(
      c(
        albumin = "Albumin (score)",
        hemoglobin = "Hemoglobin (g/dL)",
        packed_cell_volume = "PCV (%)",
        red_blood_cell_count = "RBC count (millions/mcL)",
        serum_creatinine = "Creatinine (mg/dL)"
      )
    )
  ) +
  theme_minimal() +
  labs(
    title = "Key continuous predictors by CKD classification",
    x = "Classification",
    y = "Value"
  ) +
  scale_fill_manual(
    values = c("ckd" = "#EE3B3B", "notckd" = "#1b9e77"),
    labels = c("ckd" = "Diagnosed", "notckd" = "Not diagnosed")
  )

```
