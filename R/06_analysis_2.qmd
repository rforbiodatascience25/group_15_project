---
title: "06_analysis_2"
format:
  html:
    embed-resources: true
editor: visual
execute: 
  echo: true
  message: false
  warning: false
---

## Loading libraries

```{r}
library("tidyverse")
```

## Loading augmented data

```{r}
kidney_merged_GFR <- read_rds("../data/03_data_augment.rds")
```

## Prepare variables for Analysis

Here we make sure that the key categorical variables are treated as factors and that the CKD stages have an ordered structure.

```{r}
kidney_analysis <- kidney_merged_GFR |>
mutate(
  classification = as.factor(classification),
  hypertension = as.factor(hypertension),
  diabetes_mellitus = as.factor(diabetes_mellitus),
  coronary_artery_disease = as.factor(coronary_artery_disease),
  anemia = as.factor(anemia),
  pedal_edema = as.factor(pedal_edema),
  cdk_stage = factor(
    cdk_stage,
    levels = c("stage_1", "stage_2", "stage_3a", "stage_3b", "stage_4", "stage_5"),
    ordered = TRUE
    )
  )
```

## Question 1: Is kidney function (GFR) lower in CKD patients?

We expect individuals with a CKD diagnosis to have lower estimated glomerular filtration rate (GFR).

```{r}
kidney_analysis |>
  drop_na(GFR_average, classification) |>
  group_by(classification) |>
  summarise(
    n = n(),
    mean_GFR = mean(GFR_average),
    median_GFR = median(GFR_average),
    sd_GFR = sd(GFR_average)
    )

```

Visualize GFR by CKD classification

```{r}
kidney_analysis |>
  drop_na(GFR_average, classification) |>
  ggplot(aes(x = classification, y = GFR_average, fill = classification)) +
  geom_boxplot() +
  theme_minimal() +
  theme(legend.position="none") +
  labs(
    title = "Estimated GFR by CKD classification",
    x = "Classification",
    y = "Estimated GFR (ml/min)") +
  scale_x_discrete(labels = c("CKD diagnosis", "No CKD diagnosis"))

```

## Question 2: How are CKD stages distributed between diagnosed and non-diagnosed individuals?

Here we look at how the GFR-based CKD stages are distributed in people with and without a CKD diagnosis.

```{r}
kidney_analysis |>
  drop_na(cdk_stage, classification) |>
  count(cdk_stage, classification) |>
  group_by(classification) |>
  mutate(prop = n / sum(n))

```

```{r}
stage_labs <- c("Normal", 
                "Mild", 
                "Mild to moderate", 
                "Moderate to severe",
                "Severe", 
                "Failure")

kidney_analysis |>
  drop_na(cdk_stage, classification) |>
  ggplot(aes(x = cdk_stage, fill = classification)) +
  geom_bar(position = "fill") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "Distribution of GFR-based CKD stages by classification",
    x = NULL,
    y = "Proportion within classification group"
    ) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_discrete(
    labels = c("ckd" = "CKD diagnosis", "notckd" = "No CKD diagnosis")
    ) +
  scale_x_discrete(labels = stage_labs)

```

## Question 3: Are hypertension and diabetes more common among CKD patients?

Hypertension and diabetes are known risk factors for CKD. Here we compare their prevalence between groups.

```{r}
kidney_analysis |>
  drop_na(hypertension, classification) |>
  count(classification, hypertension) |>
  group_by(classification) |>
  mutate(prop = n / sum(n))

```

Visualization

```{r}
kidney_analysis |>
  drop_na(hypertension, classification) |>
  ggplot(aes(x = hypertension, fill = classification)) +
  geom_bar(
    position = position_dodge(preserve = "single")) +   
  theme_minimal() +
  labs(
    title = "Hypertension by CKD classification",
    x = "Hypertension",
    y = "Number of people"
  ) +
  scale_fill_discrete(
    labels = c("ckd" = "CKD diagnosis", "notckd" = "No CKD diagnosis")
    )

```

## Diabetes vs Classification

```{r}
kidney_analysis |>
  drop_na(diabetes_mellitus, classification) |>
  count(classification, diabetes_mellitus) |>
  group_by(classification) |>
  mutate(prop = n / sum(n))

```

```{r}
kidney_analysis |>
  drop_na(diabetes_mellitus, classification) |>
  ggplot(aes(x = diabetes_mellitus, fill = classification)) +
  geom_bar(position = position_dodge(preserve = "single")) +
  theme_minimal() +
  labs(
    title = "Diabetes mellitus by CKD classification",
    x = "Diabetes mellitus",
    y = "Number of people"
  ) +
  scale_fill_discrete(
    labels = c("ckd" = "CKD diagnosis", "notckd" = "No CKD diagnosis")
    )
```

```{r}
kidney_analysis <- read_rds("../data/04_data_analysis.rds")
# 1) Pivot to long format for the key continuous predictors
kidney_analysis2 <- kidney_analysis |>
  select(classification,
         albumin,
         serum_creatinine,
         hemoglobin,
         packed_cell_volume,
         red_blood_cell_count) |>
  pivot_longer(
    cols = -classification,
    names_to = "variable",
    values_to = "value"
  ) |>
  drop_na(value)   

# 2) Get per-variable y-limits so we can place n above all boxplots
ylims <- kidney_analysis2 |>
  group_by(variable) |>
  summarise(
    top = max(value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(y_pos = top + (top * 0.15))   

# 3) Compute n per variable *and* classification, then join y_pos
n_labels <- kidney_analysis2 |>
  group_by(variable, classification) |>
  summarise(
    n = n(),               
    .groups = "drop"
  ) |>
  left_join(ylims, by = "variable")

# 4) Faceted boxplot with n labels for CKD and non-CKD in each facet
ggplot(kidney_analysis2,
       aes(x = classification, y = value, fill = classification)) +
  geom_boxplot() +
  geom_text(
    data = n_labels,
    aes(x = classification, y = y_pos, label = paste0("n = ", n)),
    size = 3
  ) +
  facet_wrap(
    ~ variable,
    scales = "free_y",
    labeller = as_labeller(
      c(
        albumin = "Albumin (score)",
        hemoglobin = "Hemoglobin (g/dL)",
        packed_cell_volume = "PCV (%)",
        red_blood_cell_count = "RBC count (millions/mcL)",
        serum_creatinine = "Creatinine (mg/dL)"
      )
    )
  ) +
  theme_minimal() +
  labs(
    title = "Key continuous predictors by CKD classification",
    x = "Classification",
    y = "Value"
  ) +
  scale_fill_manual(
    values = c("ckd" = "#EE3B3B", "notckd" = "#1b9e77"),
    labels = c("ckd" = "Diagnosed", "notckd" = "Not diagnosed")
  )
```
