---
title: "06_analysis_2"
format:
  html:
    embed-resources: true
    output-file: 06_analysis_2.html
    output-dir: results
editor: visual
execute: 
  echo: true
  message: false
  warning: false
---

## Giosu√®

## Correlation plot

The corr plot shows the correlation between all the numeric variables in the dataset, from there we can inspect if there is correlation between variables and how strong.

```{r}
library("tidyverse")
library("PerformanceAnalytics")

kidney_augmented <- read_rds("../data/03_data_augment.rds")

kidney_augmented |>
  select(age, blood_pressure, blood_glucose_random, blood_urea, serum_creatinine, sodium, potassium, hemoglobin, packed_cell_volume, white_blood_cell_count, red_blood_cell_count, GFR_male, GFR_female, GFR_average) |>
  chart.Correlation(histogram = TRUE, pch = 19)
```

## Random forest analysis

Using random forest we are inspecting the variable importance, to further select our variables. This also includes factor variables.

```{r}
library(randomForest)
library(caret)

set.seed(123)

kidney_augmented <- read_rds("../data/03_data_augment.rds")

data <- kidney_augmented |> 
  na.omit() |>
  select(-c(GFR_female, GFR_male, GFR_average, cdk_stage, specific_gravity))

idx <- data$classification |>
  createDataPartition(p = 0.6, list = F)

train <- data[idx,]
test <- data[-idx,]

rf1 <- train |> 
  randomForest(classification ~ ., data = _, importance = T, ntree = 600)

plot(rf1$err.rate[,1], type='l')
```

### Visualizing the confusion matrix

This is used to see the model performance on the test set.

```{r}
pred <- predict(rf1,test)
confusionMatrix(pred,test$classification)
```

### Variables importance plot

This plot is used to see how much each variable is influencing the accuracy of the model.

```{r}
varImpPlot(rf1)
```

### Repeating random forest analysis with important variables

```{r}
kidney_augmented <- read_rds("../data/03_data_augment.rds")

data <- kidney_augmented |> 
  na.omit() |>
  select(-c(GFR_female, GFR_male, GFR_average, cdk_stage, specific_gravity))

idx <- data$classification |>
  createDataPartition(p = 0.6, list = F)

train <- data[idx,]
test <- data[-idx,]

rf2 <- train |> 
  randomForest(classification ~ packed_cell_volume + hemoglobin +
                 serum_creatinine + red_blood_cell_count + albumin + hypertension + diabetes_mellitus,
               data = _, 
               importance = T, 
               ntree = 600)

plot(rf2$err.rate[,1], type='l')
```

```{r}
pred <- predict(rf2,test)
confusionMatrix(pred,test$classification)
```

```{r}
varImpPlot(rf2)
```

## Joel
